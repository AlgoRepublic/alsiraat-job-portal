# ============================================
# GitLab CI/CD Pipeline for Tasker
# ============================================
#
# This pipeline builds and pushes the Tasker application
# to a private Docker registry.
#
# Required CI/CD Variables (Settings > CI/CD > Variables):
#   - REGISTRY: Registry URL (e.g., yourdomain.com)
#   - REGISTRY_USER: Registry username
#   - REGISTRY_PASSWORD: Registry password (masked)

# Only run pipeline on master branch
workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "master"

stages:
  - build-and-push

# ============================================
# Global Variables
# ============================================
variables:
  FRONTEND_IMAGE: tasker-frontend
  BACKEND_IMAGE: tasker-backend
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA
  DOCKER_TLS_CERTDIR: "/certs"

# ============================================
# Template: Docker build job
# ============================================
.docker-job:
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: /certs/client
  before_script:
    - echo "$REGISTRY_PASSWORD" | docker login "$REGISTRY" -u "$REGISTRY_USER" --password-stdin

# ============================================
# Build and push frontend
# ============================================
frontend:
  extends: .docker-job
  stage: build-and-push
  script:
    - echo "Building frontend image..."
    - >
      docker build
      -f frontend.Dockerfile
      -t $FRONTEND_IMAGE:$IMAGE_TAG
      -t $FRONTEND_IMAGE:latest
      .
    - echo "Pushing frontend image..."
    - docker push $FRONTEND_IMAGE:$IMAGE_TAG
    - docker push $FRONTEND_IMAGE:latest

# ============================================
# Build and push backend
# ============================================
backend:
  extends: .docker-job
  stage: build-and-push
  script:
    - echo "Building backend image..."
    - >
      docker build
      -f backend/Dockerfile
      -t $BACKEND_IMAGE:$IMAGE_TAG
      -t $BACKEND_IMAGE:latest
      ./backend
    - echo "Pushing backend image..."
    - docker push $BACKEND_IMAGE:$IMAGE_TAG
    - docker push $BACKEND_IMAGE:latest

